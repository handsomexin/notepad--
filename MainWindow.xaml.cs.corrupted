using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Threading;
using Microsoft.Win32;
using SmartTextEditor.Services;
using SmartTextEditor.Models;
using SmartTextEditor.Windows;
using SmartTextEditor.Themes;
using System.IO.Compression;

namespace SmartTextEditor
{
    /// <summary>
    /// MainWindow.xaml çš„äº¤äº’é€»è¾‘ - æ”¯æŒå¤šæ ‡ç­¾é¡µ - æé€Ÿå¯åŠ¨ä¼˜åŒ–
    /// </summary>
    public partial class MainWindow : Window
    {
        // å»¶è¿Ÿåˆå§‹åŒ–çš„æœåŠ¡
        private EncodingDetector _encodingDetector;
        private DispatcherTimer _autoCacheTimer;
        private readonly string _cacheDirectory = Path.Combine(Directory.GetCurrentDirectory(), "Cache");
        private readonly ObservableCollection<FileTabItem> _tabItems;
        private FileTabItem _currentTab;
        private int _newFileCounter = 1;
        private bool _isFullyInitialized = false;
        
        // æ·»åŠ ä¸»é¢˜é¢„è§ˆç›¸å…³å­—æ®µ
        private ThemeType _previewTheme = ThemeType.Dark;
        private bool _isPreviewingTheme = false;
        
        // æ·»åŠ å¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–å­—æ®µ
        private const int LARGE_FILE_THRESHOLD = 50000; // 50KBé˜ˆå€¼
        private const int HUGE_FILE_THRESHOLD = 1000000; // 1MBé˜ˆå€¼
        
        // æ·»åŠ ç¼“å­˜ä¼˜åŒ–å­—æ®µ
        private const int CACHE_COMPRESS_THRESHOLD = 50000; // 50KBé˜ˆê°’
        private const int CACHE_CLEANUP_INTERVAL = 7; // 7å¤©æ¸…ç†ä¸€æ¬¡
        private readonly object _cacheLock = new object(); // ç¼“å­˜æ“ä½œé”

        public MainWindow()
        {
            // æç®€åˆå§‹åŒ–ï¼Œåªåšå¿…è¦çš„UIåˆå§‹åŒ–
            InitializeComponent();
            _tabItems = new ObservableCollection<FileTabItem>();
            
            // è®¾ç½®çª—å£åŸºæœ¬å±æ€§ï¼ˆå»¶è¿Ÿåˆ°æ˜¾ç¤ºåï¼‰
            this.Title = "Smart Text Editor";
            
            // åŠ è½½ä¿å­˜çš„çª—å£è®¾ç½®
            LoadWindowSettings();
            
            // åˆ›å»ºæœ€ç®€å•çš„æ¬¢è¿æ ‡ç­¾é¡µ
            CreateMinimalWelcomeTab();
        }

        private void LoadWindowSettings()
        {
            try
            {
                var config = ConfigManager.LoadConfig();
                if (config.RememberWindowSize)
                {
                    this.Width = config.WindowWidth;
                    this.Height = config.WindowHeight;
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"åŠ è½½çª—å£è®¾ç½®å¤±è´¥: {ex.Message}");
            }
        }

        private async Task RestoreLastSession()
        {
            try
            {
                var (sessionTabs, activeTabIndex) = ConfigManager.LoadSession();
                
                if (sessionTabs == null || sessionTabs.Count == 0)
                {
                    System.Diagnostics.Debug.WriteLine("æ²¡æœ‰ä¸Šæ¬¡ä¼šè¯éœ€è¦æ¢å¤");
                    return;
                }

                // ç§»é™¤é»˜è®¤æ¬¢è¿æ ‡ç­¾é¡µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (_tabItems.Count > 0 && _tabItems[0].FileName == "æ¬¢è¿")
                {
                    var welcomeTab = _tabItems[0];
                    _tabItems.RemoveAt(0);
                    
                    var tabControl = FileTabControl;
                    if (tabControl?.Items.Count > 0)
                    {
                        tabControl.Items.RemoveAt(0);
                    }
                }

                // æ¢å¤æ¯ä¸ªæ ‡ç­¾é¡µ
                for (int i = 0; i < sessionTabs.Count; i++)
                {
                    var sessionTab = sessionTabs[i];
                    await RestoreTabFromSession(sessionTab);
                }

                // è®¾ç½®æ´»è·ƒæ ‡ç­¾é¡µ
                if (activeTabIndex >= 0 && activeTabIndex < _tabItems.Count)
                {
                    SwitchToTab(_tabItems[activeTabIndex]);
                }
                else if (_tabItems.Count > 0)
                {
                    SwitchToTab(_tabItems[0]);
                }

                UpdateStatus($"å·²æ¢å¤ä¸Šæ¬¡ä¼šè¯ï¼š{sessionTabs.Count}ä¸ªæ ‡ç­¾é¡µ");
                System.Diagnostics.Debug.WriteLine($"ä¼šè¯æ¢å¤å®Œæˆï¼š{sessionTabs.Count}ä¸ªæ ‡ç­¾é¡µ");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"æ¢å¤ä¼šè¯å¤±è´¥: {ex.Message}");
                UpdateStatus("æ¢å¤ä¸Šæ¬¡ä¼šè¯å¤±è´¥");
            }
        }

        private async Task RestoreTabFromSession(ConfigManager.SessionTab sessionTab)
        {
            try
            {
                await Task.Run(() =>
                {
                    Dispatcher.Invoke(() =>
                    {
                        // å¦‚æœæœ‰æ–‡ä»¶è·¯å¾„ä¸”æ–‡ä»¶å­˜åœ¨ï¼Œå°è¯•é‡æ–°åŠ è½½æ–‡ä»¶
                        if (!string.IsNullOrEmpty(sessionTab.FilePath) && File.Exists(sessionTab.FilePath))
                        {
                            try
                            {
                                // è¯»å–æœ€æ–°æ–‡ä»¶å†…å®¹
                                var encoding = GetEncodingByName(sessionTab.Encoding);
                                var currentContent = File.ReadAllText(sessionTab.FilePath, encoding);
                                
                                // å¦‚æœæ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–æˆ–è€…ä¼šè¯ä¸­æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œä½¿ç”¨ä¼šè¯å†…å®¹
                                var contentToUse = sessionTab.IsModified ? sessionTab.Content : currentContent;
                                CreateTabFromSession(sessionTab, contentToUse);
                            }
                            catch (Exception ex)
                            {
                                System.Diagnostics.Debug.WriteLine($"è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨ä¼šè¯å†…å®¹: {ex.Message}");
                                CreateTabFromSession(sessionTab, sessionTab.Content);
                            }
                        }
                        else
                        {
                            // æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ˜¯æ–°æ–‡ä»¶ï¼Œä½¿ç”¨ä¼šè¯ä¸­çš„å†…å®¹
                            CreateTabFromSession(sessionTab, sessionTab.Content);
                        }
                    });
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"æ¢å¤æ ‡ç­¾é¡µå¤±è´¥: {ex.Message}");
            }
        }

        private void CreateTabFromSession(ConfigManager.SessionTab sessionTab, string content)
        {
            try
            {
                // åˆ›å»ºæ ‡ç­¾é¡µ
                CreateNewTab(sessionTab.FileName, content);
                
                // è·å–åˆšåˆ›å»ºçš„æ ‡ç­¾é¡µ
                var newTab = _tabItems.LastOrDefault();
                if (newTab != null)
                {
                    // æ¢å¤å±æ€§
                    newTab.FilePath = sessionTab.FilePath;
                    newTab.Encoding = sessionTab.Encoding;
                    
                    // è®¾ç½®åŸå§‹å†…å®¹å’Œå½“å‰å†…å®¹æ¥æ¢å¤ä¿®æ”¹çŠ¶æ€
                    newTab.OriginalContent = sessionTab.IsModified ? "" : content;
                    newTab.Content = content;
                    
                    // æ¢å¤å…‰æ ‡ä½ç½®å’Œé€‰æ‹©
                    if (newTab.TextEditor != null)
                    {
                        newTab.TextEditor.CaretIndex = Math.Min(sessionTab.CursorPosition, content.Length);
                        if (sessionTab.SelectionLength > 0)
                        {
                            var selStart = Math.Min(sessionTab.SelectionStart, content.Length);
                            var selLength = Math.Min(sessionTab.SelectionLength, content.Length - selStart);
                            newTab.TextEditor.Select(selStart, selLength);
                        }
                    }
                    
                    // æ›´æ–°æ ‡é¢˜å’ŒçŠ¶æ€
                    UpdateTabHeader(newTab);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"ä»ä¼šè¯åˆ›å»ºæ ‡ç­¾é¡µå¤±è´¥: {ex.Message}");
            }
        }

        private Encoding GetEncodingByName(string encodingName)
        {
            try
            {
                return encodingName.ToUpper() switch
                {
                    "UTF-8" => Encoding.UTF8,
                    "GBK" => Encoding.GetEncoding("GBK"),
                    "UTF-16" => Encoding.Unicode,
                    "ASCII" => Encoding.ASCII,
                    _ => Encoding.UTF8
                };
            }
            catch
            {
                return Encoding.UTF8;
            }
        }
        
        /// <summary>
        /// å¼‚æ­¥å®Œæˆå‰©ä½™çš„åˆå§‹åŒ–å·¥ä½œ
        /// </summary>
        public async Task CompleteInitializationAsync()
        {
            if (_isFullyInitialized) return;
            
            try
            {
                await Dispatcher.InvokeAsync(async () =>
                {
                    // å»¶è¿Ÿåˆå§‹åŒ–æœåŠ¡
                    await Task.Run(() =>
                    {
                        _encodingDetector = new EncodingDetector();
                    });
                    
                    // åˆå§‹åŒ–ç¼–è¾‘å™¨åŠŸèƒ½
                    InitializeEditor();
                    
                    // åˆå§‹åŒ–è‡ªåŠ¨ç¼“å­˜
                    InitializeAutoCache();
                    
                    // å®Œå–„æ¬¢è¿é¡µå†…å®¹
                    CompleteWelcomeTab();
                    
                    // åˆå§‹åŒ–ä¸»é¢˜ç³»ç»Ÿ
                    InitializeThemeSystem();
                    
                    // æ¢å¤ä¸Šæ¬¡ä¼šè¯
                    await RestoreLastSession();
                    
                    _isFullyInitialized = true;
                    
                    // æ›´æ–°çŠ¶æ€
                    UpdateStatus("å°±ç»ª - æ‰€æœ‰åŠŸèƒ½å·²åŠ è½½");
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
            }
        }

        #region åˆå§‹åŒ–

        private void CreateMinimalWelcomeTab()
        {
            // æç®€æ¬¢è¿é¡µï¼Œåªæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            var welcomeContent = "ğŸš€ Smart Text Editor - æ¬¢è¿å…‰ä¸´";

            var welcomeTab = new FileTabItem
            {
                FileName = "æ¬¢è¿",
                Content = welcomeContent
            };
            welcomeTab.OriginalContent = welcomeContent;

            _tabItems.Add(welcomeTab);
            _currentTab = welcomeTab;

            // ç®€å•è®¾ç½®æ¬¢è¿é¡µå†…å®¹ï¼ˆæ— äº‹ä»¶ç»‘å®šï¼‰
            if (WelcomeTextEditor != null)
            {
                WelcomeTextEditor.Text = welcomeContent;
            }
            if (WelcomeLineNumbers != null)
            {
                WelcomeLineNumbers.Text = "1";
            }
        }
        
        private void CompleteWelcomeTab()
        {
            // åœ¨å¼‚æ­¥åˆå§‹åŒ–åå®Œå–„æ¬¢è¿é¡µå†…å®¹
            var fullWelcomeContent = @"ğŸ‰ æ¬¢è¿ä½¿ç”¨ Smart Text Editor v1.3ï¼

âœ¨ æœ€æ–°åŠŸèƒ½ - æ™ºèƒ½ä¼šè¯æ¢å¤ï¼š
â€¢ ä¼šè¯è‡ªåŠ¨ä¿å­˜ - å…³é—­ç¨‹åºæ—¶è‡ªåŠ¨ä¿å­˜æ‰€æœ‰æ ‡ç­¾é¡µ
â€¢ æ— ç¼æ¢å¤ä½“éªŒ - é‡å¯åå®Œå…¨æ¢å¤å·¥ä½œçŠ¶æ€
â€¢ æ™ºèƒ½çŠ¶æ€ä¿æŒ - æ–‡ä»¶å†…å®¹ã€ä¿®æ”¹çŠ¶æ€ã€å…‰æ ‡ä½ç½®
â€¢ ç¼–ç æ ¼å¼è®°å¿† - å„æ–‡ä»¶ç¼–ç è®¾ç½®å®Œæ•´ä¿ç•™
â€¢ å¼‚å¸¸æƒ…å†µå¤„ç† - æ–‡ä»¶ç§»åŠ¨åˆ é™¤çš„æ™ºèƒ½å¤„ç†

ğŸ¨ å¤šä¸»é¢˜ç³»ç»Ÿï¼š
â€¢ 6ç§ç²¾ç¾ä¸»é¢˜ - é€‚åº”ä¸åŒä½¿ç”¨åœºæ™¯
â€¢ æ™ºèƒ½ä¸»é¢˜è®°å¿† - ç¨‹åºè®°ä½æ‚¨çš„ä¸»é¢˜é€‰æ‹©
â€¢ è‡ªåŠ¨ä¿å­˜è®¾ç½® - ä¸‹æ¬¡å¯åŠ¨è‡ªåŠ¨åº”ç”¨
â€¢ çª—å£å¤§å°è®°å¿† - ä¿æŒæ‚¨å–œæ¬¢çš„ç•Œé¢å¸ƒå±€

ğŸ’¾ ä¼šè¯æ¢å¤ç‰¹æ€§ï¼š
â€¢ æ ‡ç­¾é¡µå®Œæ•´æ¢å¤ - æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶è‡ªåŠ¨æ¢å¤
â€¢ ç¼–è¾‘çŠ¶æ€ä¿æŒ - å…‰æ ‡ä½ç½®ã€æ–‡æœ¬é€‰æ‹©çŠ¶æ€
â€¢ ä¿®æ”¹çŠ¶æ€è®°å¿† - æœªä¿å­˜ä¿®æ”¹çš„å®Œæ•´ä¿ç•™
â€¢ æ´»è·ƒæ ‡ç­¾æ¢å¤ - æ¢å¤åˆ°å…³é—­å‰çš„å·¥ä½œæ ‡ç­¾
â€¢ æ··åˆæ–‡ä»¶æ”¯æŒ - æ–°æ–‡ä»¶ã€å·²ä¿å­˜æ–‡ä»¶ç»Ÿä¸€å¤„ç†

âŒ¨ï¸ æ“ä½œæŒ‡å—ï¼š
â€¢ æ­£å¸¸ç¼–è¾‘å·¥ä½œï¼Œç¨‹åºä¼šè‡ªåŠ¨è®°å½•çŠ¶æ€
â€¢ å…³é—­ç¨‹åºæ—¶ä¼šè‡ªåŠ¨ä¿å­˜å½“å‰ä¼šè¯
â€¢ é‡æ–°å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤åˆ°ä¸Šæ¬¡çš„å·¥ä½œçŠ¶æ€
â€¢ é…ç½®æ–‡ä»¶ï¼š%LOCALAPPDATA%\SmartTextEditor\

âŒ¨ï¸ å¿«æ·é”®ï¼š
â€¢ Ctrl+N - æ–°å»ºæ ‡ç­¾é¡µ
â€¢ Ctrl+O - æ‰“å¼€æ–‡ä»¶
â€¢ Ctrl+S - ä¿å­˜æ–‡ä»¶
â€¢ Ctrl+D - æ–‡ä»¶å¯¹æ¯”
â€¢ Ctrl+Tab - åˆ‡æ¢æ ‡ç­¾é¡µ

ğŸš€ äº«å—æ— ç¼çš„å·¥ä½œä½“éªŒå§ï¼";

            if (_currentTab != null && _currentTab.FileName == "æ¬¢è¿")
            {
                _currentTab.Content = fullWelcomeContent;
                _currentTab.OriginalContent = fullWelcomeContent;
                WelcomeTextEditor.Text = fullWelcomeContent;
                
                // è®¾ç½®äº‹ä»¶å¤„ç†
                WelcomeTextEditor.TextChanged += (s, e) => OnCurrentTabTextChanged();
                WelcomeTextEditor.SelectionChanged += (s, e) => {
                    UpdateCursorPosition();
                    UpdateSelectionInfo();
                };
                WelcomeTextEditor.PreviewKeyDown += TextEditor_PreviewKeyDown;
                
                UpdateLineNumbers(WelcomeLineNumbers, WelcomeTextEditor);
                UpdateCursorPosition();
                UpdateSelectionInfo();
            }
        }

        private void InitializeEditor()
        {
            try
            {
                UpdateTitle();
                this.CommandBindings.Add(new CommandBinding(ApplicationCommands.New, (s, e) => NewFile()));
                this.CommandBindings.Add(new CommandBinding(ApplicationCommands.Open, (s, e) => OpenFile()));
                this.CommandBindings.Add(new CommandBinding(ApplicationCommands.Save, (s, e) => SaveFile()));
                this.CommandBindings.Add(new CommandBinding(ApplicationCommands.Properties, (s, e) => FileCompare()));
                this.CommandBindings.Add(new CommandBinding(ApplicationCommands.Find, (s, e) => ShowFindDialog()));
                this.CommandBindings.Add(new CommandBinding(ApplicationCommands.Replace, (s, e) => ShowFindReplaceDialog()));
                this.CommandBindings.Add(new CommandBinding(NavigationCommands.Search, (s, e) => FindNext()));
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"ç¼–è¾‘å™¨åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
            }
        }

        private void InitializeThemeSystem()
        {
            try
            {
                // åŠ è½½ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
                var savedTheme = ConfigManager.LoadTheme();
                
                // è®¾ç½®ä¸»é¢˜
                ThemeManager.SetTheme(savedTheme);
                var themeColors = ThemeManager.GetCurrentThemeColors();

                // åº”ç”¨ä¸»é¢˜åˆ°ä¸»çª—å£
                ThemeApplier.ApplyThemeToMainWindow(this, themeColors);

                // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
                foreach (var tabItem in _tabItems)
                {
                    ThemeApplier.ApplyToTabItem(tabItem, themeColors);
                }

                // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
                UpdateThemeMenuSelection(savedTheme);

                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå·²åŠ è½½ä¸»é¢˜: {themeColors.Name}");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {ex.Message}");
            }
        }

        #endregion

        #region æ ‡ç­¾é¡µç®¡ç†

        private void CreateNewTab(string fileName = null, string content = "")
        {
            try
            {
                var tabItem = new FileTabItem
                {
                    FileName = fileName ?? $"æ— æ ‡é¢˜{_newFileCounter++}",
                    Content = content,
                    Encoding = "UTF-8"
                };
                tabItem.OriginalContent = content;

                // è·å–TabControl
                var tabControl = FileTabControl;
                if (tabControl == null)
                {
                    MessageBox.Show("æ— æ³•æ‰¾åˆ°æ ‡ç­¾é¡µæ§ä»¶", "é”™è¯¯");
                    return;
                }

                // åˆ›å»ºæ–°çš„æ ‡ç­¾é¡µUI
                var newTabItem = new TabItem
                {
                    Header = tabItem.DisplayName,
                    DataContext = tabItem
                };

                // åˆ›å»ºç¼–è¾‘å™¨å†…å®¹
                var grid = new Grid();
                grid.ColumnDefinitions.Add(new ColumnDefinition { Width = GridLength.Auto, MinWidth = 35 });
                grid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) });

                var lineNumbers = new TextBox
                {
                    Background = new SolidColorBrush(Color.FromRgb(0x16, 0x1B, 0x22)),
                    Foreground = new SolidColorBrush(Color.FromRgb(0x7D, 0x85, 0x90)),
                    BorderThickness = new Thickness(0, 0, 1, 0),
                    BorderBrush = new SolidColorBrush(Color.FromRgb(0x30, 0x36, 0x3D)),
                    FontFamily = new FontFamily("Consolas"),
                    FontSize = 13,
                    IsReadOnly = true,
                    IsTabStop = false,
                    VerticalScrollBarVisibility = ScrollBarVisibility.Hidden,
                    HorizontalScrollBarVisibility = ScrollBarVisibility.Hidden,
                    TextAlignment = TextAlignment.Right,
                    Padding = new Thickness(8, 12, 8, 12),
                    Width = 35,
                    MinWidth = 35
                };

                var textEditor = new TextBox
                {
                    Background = new SolidColorBrush(Color.FromRgb(0x0D, 0x11, 0x17)),
                    Foreground = new SolidColorBrush(Color.FromRgb(0xE6, 0xED, 0xF3)),
                    BorderBrush = new SolidColorBrush(Color.FromRgb(0x30, 0x36, 0x3D)),
                    BorderThickness = new Thickness(1),
                    FontFamily = new FontFamily("Consolas"),
                    FontSize = 14,
                    Padding = new Thickness(12),
                    AcceptsReturn = true,
                    AcceptsTab = true,
                    VerticalScrollBarVisibility = ScrollBarVisibility.Auto,
                    HorizontalScrollBarVisibility = ScrollBarVisibility.Auto,
                    TextWrapping = TextWrapping.NoWrap,
                    Text = content
                };

                // ç»‘å®šäº‹ä»¶
                textEditor.TextChanged += (s, e) => {
                    try {
                        OnTabTextChanged(tabItem, textEditor);
                    } catch (Exception ex) {
                        System.Diagnostics.Debug.WriteLine($"æ–‡æœ¬å˜åŒ–äº‹ä»¶é”™è¯¯: {ex.Message}");
                    }
                };
                textEditor.SelectionChanged += (s, e) => {
                    try {
                        UpdateCursorPosition();
                        UpdateSelectionInfo();
                    } catch (Exception ex) {
                        System.Diagnostics.Debug.WriteLine($"é€‰æ‹©å˜åŒ–äº‹ä»¶é”™è¯¯: {ex.Message}");
                    }
                };
                textEditor.PreviewKeyDown += TextEditor_PreviewKeyDown;
                
                // æ·»åŠ æ»šåŠ¨åŒæ­¥äº‹ä»¶ - ä½¿ç”¨é™„åŠ å±æ€§
                textEditor.AddHandler(ScrollViewer.ScrollChangedEvent, new ScrollChangedEventHandler((s, e) => {
                    try {
                        // åŒæ­¥è¡Œå·æ»šåŠ¨
                        if (lineNumbers != null)
                        {
                            lineNumbers.ScrollToVerticalOffset(e.VerticalOffset);
                        }
                    } catch (Exception ex) {
                        System.Diagnostics.Debug.WriteLine($"æ»šåŠ¨åŒæ­¥é”™è¯¯: {ex.Message}");
                    }
                }));

                // è®¾ç½®æ§ä»¶å¼•ç”¨
                tabItem.TextEditor = textEditor;
                tabItem.LineNumbersEditor = lineNumbers;

                Grid.SetColumn(lineNumbers, 0);
                Grid.SetColumn(textEditor, 1);
                grid.Children.Add(lineNumbers);
                grid.Children.Add(textEditor);

                newTabItem.Content = grid;
                _tabItems.Add(tabItem);

                // æ·»åŠ åˆ°TabControl
                tabControl.Items.Add(newTabItem);
                tabControl.SelectedItem = newTabItem;

                _currentTab = tabItem;
                UpdateLineNumbers(lineNumbers, textEditor);
                UpdateTitle();
                UpdateTabList();
                
                // åº”ç”¨å½“å‰ä¸»é¢˜åˆ°æ–°æ ‡ç­¾é¡µ
                if (_isFullyInitialized)
                {
                    var currentTheme = ThemeManager.GetCurrentThemeColors();
                    ThemeApplier.ApplyToTabItem(tabItem, currentTheme);
                }
                
                UpdateStatus($"å·²åˆ›å»ºæ–°æ ‡ç­¾é¡µ: {tabItem.FileName}");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"åˆ›å»ºæ ‡ç­¾é¡µå¤±è´¥: {ex.Message}", "é”™è¯¯");
                System.Diagnostics.Debug.WriteLine($"åˆ›å»ºæ ‡ç­¾é¡µé”™è¯¯: {ex}");
            }
        }

        private void CloseTab(FileTabItem tab)
        {
            try
            {
                if (tab == null) return;

                // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿å­˜
                if (tab.IsModified)
                {
                    var result = MessageBox.Show(
                        $"æ–‡ä»¶ '{tab.FileName}' å·²è¢«ä¿®æ”¹ã€‚\næ˜¯å¦è¦ä¿å­˜æ›´æ”¹ï¼Ÿ",
                        "ä¿å­˜",
                        MessageBoxButton.YesNoCancel,
                        MessageBoxImage.Question);

                    switch (result)
                    {
                        case MessageBoxResult.Yes:
                            if (!SaveTab(tab)) return; // ä¿å­˜å¤±è´¥åˆ™ä¸å…³é—­
                            break;
                        case MessageBoxResult.Cancel:
                            return; // å–æ¶ˆå…³é—­
                        case MessageBoxResult.No:
                            break; // ä¸ä¿å­˜ç›´æ¥å…³é—­
                    }
                }

                // ç§»é™¤æ ‡ç­¾é¡µ
                var tabControl = FileTabControl;
                if (tabControl != null)
                {
                    var tabItem = tabControl.Items.Cast<TabItem>().FirstOrDefault(t => t.DataContext == tab);
                    if (tabItem != null)
                    {
                        tabControl.Items.Remove(tabItem);
                    }
                }

                _tabItems.Remove(tab);

                // å¦‚æœå…³é—­çš„æ˜¯å½“å‰æ ‡ç­¾é¡µï¼Œåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µ
                if (_currentTab == tab)
                {
                    if (_tabItems.Count > 0)
                    {
                        SwitchToTab(_tabItems.Last());
                    }
                    else
                    {
                        CreateMinimalWelcomeTab(); // æ²¡æœ‰æ ‡ç­¾é¡µæ—¶åˆ›å»ºæ¬¢è¿é¡µ
                    }
                }

                UpdateTabList();
                UpdateStatus($"å·²å…³é—­æ ‡ç­¾é¡µ: {tab.FileName}");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"å…³é—­æ ‡ç­¾é¡µå¤±è´¥: {ex.Message}", "é”™è¯¯");
                System.Diagnostics.Debug.WriteLine($"å…³é—­æ ‡ç­¾é¡µé”™è¯¯: {ex}");
            }
        }

        private void SwitchToTab(FileTabItem tab)
        {
            try
            {
                if (tab == null) return;

                var tabControl = FileTabControl;
                if (tabControl == null) return;

                var tabItem = tabControl.Items.Cast<TabItem>().FirstOrDefault(t => t.DataContext == tab);
                if (tabItem != null)
                {
                    tabControl.SelectedItem = tabItem;
                    _currentTab = tab;
                    UpdateTitle();
                    UpdateCursorPosition();
                    UpdateSelectionInfo();
                    
                    if (EncodingText != null)
                    {
                        EncodingText.Text = tab.Encoding ?? "UTF-8";
                    }
                    
                    UpdateStatus($"å·²åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: {tab.FileName}");
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"åˆ‡æ¢æ ‡ç­¾é¡µé”™è¯¯: {ex.Message}");
            }
        }

        /// <summary>
        /// æ ‡ç­¾é¡µå…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        /// </summary>
        private void CloseTabButton_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button closeButton && closeButton.Tag is FileTabItem tabItem)
            {
                CloseTab(tabItem);
            }
        }

        #endregion

        #region ä¸»é¢˜ç®¡ç†

        private void SetDarkTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Dark);
        }

        private void SetLightTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Light);
        }

        private void SetHighContrastTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.HighContrast);
        }

        private void SetEyeCareTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.EyeCare);
        }

        private void SetMonokaiTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Monokai);
        }

        private void SetSolarizedTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Solarized);
        }

        /// <summary>
        /// é¢„è§ˆå¹¶è®¾ç½®ä¸»é¢˜
        /// </summary>
        private void PreviewAndSetTheme(ThemeType themeType)
        {
            try
            {
                // å¦‚æœæ­£åœ¨é¢„è§ˆå…¶ä»–ä¸»é¢˜ï¼Œå…ˆæ¢å¤å½“å‰ä¸»é¢˜
                if (_isPreviewingTheme && _previewTheme != ThemeManager.CurrentTheme)
                {
                    // æ¢å¤å½“å‰ä¸»é¢˜
                    ApplyThemeToUI(ThemeManager.CurrentTheme);
                }
                
                // åº”ç”¨é¢„è§ˆä¸»é¢˜
                ApplyThemeToUI(themeType);
                
                // è®¾ç½®é¢„è§ˆçŠ¶æ€
                _previewTheme = themeType;
                _isPreviewingTheme = true;
                
                // 3ç§’åè‡ªåŠ¨ç¡®è®¤æˆ–æ¢å¤
                var timer = new DispatcherTimer
                {
                    Interval = TimeSpan.FromSeconds(3)
                };
                timer.Tick += (s, e) =>
                {
                    timer.Stop();
                    if (_isPreviewingTheme)
                    {
                        ConfirmTheme(themeType);
                    }
                };
                timer.Start();
            }
            catch (Exception ex)
            {
                UpdateStatus($"ä¸»é¢˜é¢„è§ˆå¤±è´¥: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜é¢„è§ˆé”™è¯¯: {ex}");
            }
        }
        
        /// <summary>
        /// åº”ç”¨ä¸»é¢˜åˆ°UIï¼ˆé¢„è§ˆæˆ–æ­£å¼åº”ç”¨ï¼‰
        /// </summary>
        private void ApplyThemeToUI(ThemeType themeType)
        {
            var themeColors = ThemeManager.GetThemeColors(themeType);
            
            // åº”ç”¨ä¸»é¢˜åˆ°ä¸»çª—å£
            ThemeApplier.ApplyThemeToMainWindow(this, themeColors);
            
            // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
            foreach (var tabItem in _tabItems)
            {
                ThemeApplier.ApplyToTabItem(tabItem, themeColors);
            }
            
            // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€ï¼ˆé¢„è§ˆæ—¶ä¸æ›´æ–°ï¼‰
            if (!_isPreviewingTheme || themeType == ThemeManager.CurrentTheme)
            {
                UpdateThemeMenuSelection(themeType);
            }
        }
        
        /// <summary>
        /// ç¡®è®¤ä¸»é¢˜é€‰æ‹©
        /// </summary>
        private void ConfirmTheme(ThemeType themeType)
        {
            try
            {
                // è®¾ç½®ä¸»é¢˜
                ThemeManager.SetTheme(themeType);
                var themeColors = ThemeManager.GetCurrentThemeColors();
                
                // åº”ç”¨ä¸»é¢˜åˆ°ä¸»çª—å£
                ThemeApplier.ApplyThemeToMainWindow(this, themeColors);
                
                // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
                foreach (var tabItem in _tabItems)
                {
                    ThemeApplier.ApplyToTabItem(tabItem, themeColors);
                }
                
                // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
                UpdateThemeMenuSelection(themeType);
                
                // ä¿å­˜ä¸»é¢˜è®¾ç½®
                ConfigManager.SaveTheme(themeType);
                
                // é‡ç½®é¢„è§ˆçŠ¶æ€
                _isPreviewingTheme = false;
                
                // æ›´æ–°çŠ¶æ€
                UpdateStatus($"ä¸»é¢˜å·²åˆ‡æ¢ä¸º: {themeColors.Name}ï¼Œå·²ä¿å­˜è®¾ç½®");
            }
            catch (Exception ex)
            {
                UpdateStatus($"ä¸»é¢˜åˆ‡æ¢å¤±è´¥: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜åˆ‡æ¢é”™è¯¯: {ex}");
            }
        }

        private void SetTheme(ThemeType themeType)
        {
            try
            {
                // è®¾ç½®ä¸»é¢˜
                ThemeManager.SetTheme(themeType);
                var themeColors = ThemeManager.GetCurrentThemeColors();

                // åº”ç”¨ä¸»é¢˜åˆ°ä¸»çª—å£
                ThemeApplier.ApplyThemeToMainWindow(this, themeColors);

                // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
                foreach (var tabItem in _tabItems)
                {
                    ThemeApplier.ApplyToTabItem(tabItem, themeColors);
                }

                // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
                UpdateThemeMenuSelection(themeType);

                // ä¿å­˜ä¸»é¢˜è®¾ç½®
                ConfigManager.SaveTheme(themeType);

                // æ›´æ–°çŠ¶æ€
                UpdateStatus($"ä¸»é¢˜å·²åˆ‡æ¢ä¸º: {themeColors.Name}ï¼Œå·²ä¿å­˜è®¾ç½®");
            }
            catch (Exception ex)
            {
                UpdateStatus($"ä¸»é¢˜åˆ‡æ¢å¤±è´¥: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜åˆ‡æ¢é”™è¯¯: {ex}");
            }
        }

        private void UpdateThemeMenuSelection(ThemeType selectedTheme)
        {
            // å–æ¶ˆæ‰€æœ‰ä¸»é¢˜èœå•é¡¹çš„é€‰ä¸­çŠ¶æ€
            DarkThemeMenuItem.IsChecked = false;
            LightThemeMenuItem.IsChecked = false;
            HighContrastThemeMenuItem.IsChecked = false;
            EyeCareThemeMenuItem.IsChecked = false;
            MonokaiThemeMenuItem.IsChecked = false;
            SolarizedThemeMenuItem.IsChecked = false;

            // è®¾ç½®å½“å‰ä¸»é¢˜èœå•é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
            switch (selectedTheme)
            {
                case ThemeType.Dark:
                    DarkThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.Light:
                    LightThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.HighContrast:
                    HighContrastThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.EyeCare:
                    EyeCareThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.Monokai:
                    MonokaiThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.Solarized:
                    SolarizedThemeMenuItem.IsChecked = true;
                    break;
            }
            
            // åŒæ—¶æ›´æ–°å·¥å…·æ ä¸Šçš„ComboBoxé€‰æ‹©
            UpdateThemeComboBox(selectedTheme);
        }
        
        private void UpdateThemeComboBox(ThemeType selectedTheme)
        {
            if (ThemeSelector == null) return;
            
            // ä¸´æ—¶ç§»é™¤äº‹ä»¶å¤„ç†å™¨ï¼Œé¿å…å¾ªç¯è§¦å‘
            ThemeSelector.SelectionChanged -= ThemeSelector_SelectionChanged;
            
            var themeTag = selectedTheme.ToString();
            foreach (ComboBoxItem item in ThemeSelector.Items)
            {
                if (item.Tag?.ToString() == themeTag)
                {
                    ThemeSelector.SelectedItem = item;
                    break;
                }
            }
            
            // é‡æ–°æ·»åŠ äº‹ä»¶å¤„ç†å™¨
            ThemeSelector.SelectionChanged += ThemeSelector_SelectionChanged;
        }
        
        private void ThemeSelector_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // é˜²æ­¢åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­è§¦å‘
            if (!_isFullyInitialized || sender is not ComboBox comboBox || comboBox.SelectedItem is not ComboBoxItem selectedItem)
                return;
                
            var themeTag = selectedItem.Tag?.ToString();
            if (Enum.TryParse<ThemeType>(themeTag, out var themeType))
            {
                SetTheme(themeType);
            }
        }

        #endregion
        
        #region æ–‡ä»¶æ“ä½œ

        private void NewFile()
        {
            CreateNewTab();
        }

        private void OpenFile()
        {
            // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆåˆå§‹åŒ–
            if (!_isFullyInitialized || _encodingDetector == null)
            {
                MessageBox.Show("åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åé‡è¯•", "æç¤º",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }
            try
            {
                var dialog = new OpenFileDialog
                {
                    Title = "æ‰“å¼€æ–‡ä»¶",
                    Filter = "æ‰€æœ‰æ–‡ä»¶ (*.*)|*.*|æ–‡æœ¬æ–‡ä»¶ (*.txt)|*.txt|C# æ–‡ä»¶ (*.cs)|*.cs|JavaScript æ–‡ä»¶ (*.js)|*.js|Python æ–‡ä»¶ (*.py)|*.py"
                };

                if (dialog.ShowDialog() == true)
                {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“å¼€äº†è¿™ä¸ªæ–‡ä»¶
                    var existingTab = _tabItems.FirstOrDefault(t => 
                        !string.IsNullOrEmpty(t.FilePath) && 
                        string.Equals(t.FilePath, dialog.FileName, StringComparison.OrdinalIgnoreCase));
                    
                    if (existingTab != null)
                    {
                        SwitchToTab(existingTab);
                        UpdateStatus($"æ–‡ä»¶å·²åœ¨æ ‡ç­¾é¡µä¸­æ‰“å¼€: {Path.GetFileName(dialog.FileName)}");
                        return;
                    }

                    LoadFileInNewTab(dialog.FileName);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"æ‰“å¼€æ–‡ä»¶å¤±è´¥: {ex.Message}", "é”™è¯¯",
                    MessageBoxButton.OK, MessageBoxImage.Error);
                System.Diagnostics.Debug.WriteLine($"æ‰“å¼€æ–‡ä»¶é”™è¯¯: {ex}");
            }
        }

        private void LoadFileInNewTab(string filePath)
        {
            try
            {
                if (!File.Exists(filePath))
                {
                    MessageBox.Show($"æ–‡ä»¶ä¸å­˜åœ¨: {filePath}", "é”™è¯¯");
                    return;
                }

                // æ£€æµ‹ç¼–ç 
                var encodingResult = _encodingDetector.DetectFileEncoding(filePath);
                
                // è¯»å–æ–‡ä»¶
                var content = File.ReadAllText(filePath, encodingResult.Encoding);
                var fileName = Path.GetFileName(filePath);

                // åˆ›å»ºæ–°æ ‡ç­¾é¡µ
                CreateNewTab(fileName, content);
                
                // è®¾ç½®æ–‡ä»¶ä¿¡æ¯
                if (_currentTab != null)
                {
                    _currentTab.FilePath = filePath;
                    _currentTab.Encoding = encodingResult.EncodingName;
                    _currentTab.OriginalContent = content;

                    UpdateStatus($"æ–‡ä»¶å·²æ‰“å¼€: {fileName} - ç¼–ç : {encodingResult.EncodingName} (ç½®ä¿¡åº¦: {encodingResult.Confidence:P0})");
                    EncodingText.Text = encodingResult.EncodingName;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"åŠ è½½æ–‡ä»¶å¤±è´¥: {ex.Message}", "é”™è¯¯");
                System.Diagnostics.Debug.WriteLine($"åŠ è½½æ–‡ä»¶é”™è¯¯: {ex}");
            }
        }

        private void SaveFile()
        {
            if (_currentTab == null) return;
            SaveTab(_currentTab);
        }

        private bool SaveTab(FileTabItem tab)
        {
            if (tab == null) return false;

            if (string.IsNullOrEmpty(tab.FilePath))
            {
                return SaveTabAs(tab);
            }

            try
            {
                // ä¿å­˜å‰åˆ›å»ºå¤‡ä»½
                if (!string.IsNullOrEmpty(tab.FilePath) && File.Exists(tab.FilePath))
                {
                    _ = Task.Run(async () =>
                    {
                        var originalContent = await File.ReadAllTextAsync(tab.FilePath);
                        await BackupManager.CreateBackupAsync(tab.FilePath, originalContent, true);
                    });
                }
                
                var encoding = GetEncodingFromName(tab.Encoding);
                File.WriteAllText(tab.FilePath, tab.Content, encoding);
                tab.MarkAsSaved();

                var fileName = Path.GetFileName(tab.FilePath);
                UpdateStatus($"æ–‡ä»¶å·²ä¿å­˜: {fileName}");
                UpdateTabHeader(tab);
                
                // ä¿å­˜ååˆ›å»ºç‰ˆæœ¬å¤‡ä»½
                _ = BackupManager.CreateBackupAsync(tab.FilePath, tab.Content, false);
                
                return true;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"ä¿å­˜å¤±è´¥ï¼š{ex.Message}", "é”™è¯¯",
                    MessageBoxButton.OK, MessageBoxImage.Error);
                return false;
            }
        }

        private void SaveAsFile()
        {
            if (_currentTab == null) return;
            SaveTabAs(_currentTab);
        }

        private bool SaveTabAs(FileTabItem tab)
        {
            if (tab == null) return false;

            var dialog = new SaveFileDialog
            {
                Title = "å¦å­˜ä¸º",
                Filter = "æ–‡æœ¬æ–‡ä»¶ (*.txt)|*.txt|æ‰€æœ‰æ–‡ä»¶ (*.*)|*.*",
                DefaultExt = "txt",
                FileName = tab.FileName
            };

            if (dialog.ShowDialog() == true)
            {
                try
                {
                    var encoding = GetEncodingFromName(tab.Encoding);
                    File.WriteAllText(dialog.FileName, tab.Content, encoding);
                    
                    tab.FilePath = dialog.FileName;
                    tab.FileName = Path.GetFileName(dialog.FileName);
                    tab.MarkAsSaved();

                    UpdateStatus($"æ–‡ä»¶å·²ä¿å­˜: {tab.FileName}");
                    UpdateTabHeader(tab);
                    return true;
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"ä¿å­˜å¤±è´¥ï¼š{ex.Message}", "é”™è¯¯",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                    return false;
                }
            }
            return false;
        }

        private void SaveAllFiles()
        {
            var modifiedTabs = _tabItems.Where(t => t.IsModified).ToList();
            foreach (var tab in modifiedTabs)
            {
                if (!SaveTab(tab))
                {
                    // å¦‚æœæœ‰æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
                    var result = MessageBox.Show(
                        $"æ–‡ä»¶ '{tab.FileName}' ä¿å­˜å¤±è´¥ã€‚\næ˜¯å¦ç»§ç»­ä¿å­˜å…¶ä»–æ–‡ä»¶ï¼Ÿ",
                        "ä¿å­˜é”™è¯¯",
                        MessageBoxButton.YesNo,
                        MessageBoxImage.Warning);
                    
                    if (result == MessageBoxResult.No) break;
                }
            }
        }

        #endregion

        #region ç¼–ç æ“ä½œ

        private void DetectEncoding()
        {
            // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆåˆå§‹åŒ–
            if (!_isFullyInitialized || _encodingDetector == null)
            {
                MessageBox.Show("åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åé‡è¯•", "æç¤º",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }
            
            if (_currentTab == null)
            {
                MessageBox.Show("è¯·å…ˆæ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ªæ–‡ä»¶", "æç¤º",
                    MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            try
            {
                string result;
                
                if (!string.IsNullOrEmpty(_currentTab.FilePath) && File.Exists(_currentTab.FilePath))
                {
                    // å¦‚æœæœ‰æ–‡ä»¶è·¯å¾„ï¼Œæ£€æµ‹æ–‡ä»¶ç¼–ç 
                    var fileResult = _encodingDetector.DetectFileEncoding(_currentTab.FilePath);
                    result = $"æ–‡ä»¶ç¼–ç æ£€æµ‹ç»“æœï¼š\n\n" +
                             $"æ–‡ä»¶è·¯å¾„: {_currentTab.FilePath}\n" +
                             $"æ£€æµ‹åˆ°çš„ç¼–ç : {fileResult.EncodingName}\n" +
                             $"ç½®ä¿¡åº¦: {fileResult.Confidence:P0}\n" +
                             $"å½“å‰ä½¿ç”¨ç¼–ç : {_currentTab.Encoding}";
                }
                else
                {
                    // å¦‚æœæ²¡æœ‰æ–‡ä»¶è·¯å¾„ï¼Œæ£€æµ‹å½“å‰æ–‡æœ¬å†…å®¹çš„ç¼–ç 
                    var content = _currentTab.Content ?? "";
                    var bytes = Encoding.UTF8.GetBytes(content);
                    var textResult = _encodingDetector.DetectEncoding(bytes);
                    
                    var charCount = content.Length;
                    var byteCount = bytes.Length;
                    
                    result = $"æ–‡æœ¬å†…å®¹ç¼–ç æ£€æµ‹ç»“æœï¼š\n\n" +
                             $"æ–‡æœ¬é•¿åº¦: {charCount} ä¸ªå­—ç¬¦\n" +
                             $"å­—èŠ‚å¤§å°: {byteCount} å­—èŠ‚\n" +
                             $"æ£€æµ‹åˆ°çš„ç¼–ç : {textResult.EncodingName}\n" +
                             $"ç½®ä¿¡åº¦: {textResult.Confidence:P0}\n" +
                             $"å½“å‰ä½¿ç”¨ç¼–ç : {_currentTab.Encoding}";
                }

                MessageBox.Show(result, "ç¼–ç æ£€æµ‹ç»“æœ",
                    MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"æ£€æµ‹å¤±è´¥ï¼š{ex.Message}", "é”™è¯¯",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void ConvertEncoding()
        {
            if (_currentTab == null) return;

            var dialog = new EncodingSelectionDialog(_currentTab.Encoding);
            if (dialog.ShowDialog() == true)
            {
                _currentTab.Encoding = dialog.SelectedEncoding;
                _currentTab.Content = _currentTab.TextEditor.Text; // è§¦å‘ä¿®æ”¹çŠ¶æ€æ›´æ–°
                EncodingText.Text = _currentTab.Encoding;
                UpdateStatus($"ç¼–ç å·²è®¾ç½®ä¸º: {_currentTab.Encoding}");
            }
        }

        private Encoding GetEncodingFromName(string encodingName)
        {
            return encodingName.ToUpper() switch
            {
                "UTF-8" => Encoding.UTF8,
                "GBK" => Encoding.GetEncoding("GBK"),
                "UTF-16" => Encoding.Unicode,
                "ASCII" => Encoding.ASCII,
                "ISO-8859-1" => Encoding.GetEncoding("ISO-8859-1"),
                _ => Encoding.UTF8
            };
        }

        #endregion

        #region UIæ›´æ–°

        private void UpdateTitle()
        {
            var title = "Smart Text Editor";
            if (_currentTab != null)
            {
                title = $"{_currentTab.DisplayName} - {title}";
            }
            Title = title;
        }

        private void UpdateTabHeader(FileTabItem tab)
        {
            var tabControl = FindName("FileTabControl") as TabControl;
            var tabItem = tabControl.Items.Cast<TabItem>().FirstOrDefault(t => t.DataContext == tab);
            if (tabItem != null)
            {
                tabItem.Header = tab.DisplayName;
            }
        }

        private void UpdateStatus(string message)
        {
            if (StatusText != null)
            {
                StatusText.Text = message;
            }
            if (StatusIndicator != null)
            {
                StatusIndicator.Fill = _currentTab?.IsModified == true ? Brushes.Orange : Brushes.LimeGreen;
            }
        }

        private void UpdateLineNumbers(TextBox lineNumbersBox, TextBox textEditor)
        {
            if (lineNumbersBox == null || textEditor == null) return;

            try
            {
                var lineCount = textEditor.LineCount;
                var charCount = textEditor.Text.Length;
                
                // å¯¹äºè¶…å¤§æ–‡ä»¶ï¼Œä½¿ç”¨è™šæ‹ŸåŒ–æ˜¾ç¤º
                if (charCount > HUGE_FILE_THRESHOLD)
                {
                    UpdateLineNumbersForHugeFile(lineNumbersBox, lineCount);
                    return;
                }
                
                // å¯¹äºå¤§æ–‡ä»¶ï¼Œä½¿ç”¨å¼‚æ­¥æ›´æ–°ä»¥é¿å…UIå†»ç»“
                if (charCount > LARGE_FILE_THRESHOLD || lineCount > 10000)
                {
                    UpdateLineNumbersAsync(lineNumbersBox, lineCount);
                    return;
                }
                
                // å°æ–‡ä»¶ç›´æ¥åŒæ­¥æ›´æ–°
                UpdateLineNumbersSync(lineNumbersBox, lineCount);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"æ›´æ–°è¡Œå·å¤±è´¥: {ex.Message}");
            }
        }
        
        private void UpdateLineNumbersSync(TextBox lineNumbersBox, int lineCount)
        {
            var lineNumbers = new StringBuilder(lineCount * 8); // é¢„åˆ†é…å®¹é‡
            
            // è®¡ç®—æœ€å¤§è¡Œå·çš„å®½åº¦ï¼Œç”¨äºå¯¹é½
            var maxLineNumber = lineCount.ToString();
            var maxWidth = maxLineNumber.Length;
            
            for (int i = 1; i <= lineCount; i++)
            {
                // å³å¯¹é½è¡Œå·
                var lineNumber = i.ToString().PadLeft(maxWidth, ' ');
                
                if (i < lineCount)
                {
                    lineNumbers.AppendLine(lineNumber);
                }
                else
                {
                    // æœ€åä¸€è¡Œä¸æ·»åŠ æ¢è¡Œç¬¦ï¼Œé¿å…å¤šä¸€ä¸ªç©ºè¡Œ
                    lineNumbers.Append(lineNumber);
                }
            }
            
            lineNumbersBox.Text = lineNumbers.ToString();
            
            // è°ƒæ•´è¡Œå·åŒºåŸŸå®½åº¦
            var expectedWidth = Math.Max(35, maxWidth * 8 + 16);
            if (Math.Abs(lineNumbersBox.Width - expectedWidth) > 5)
            {
                lineNumbersBox.Width = expectedWidth;
            }
        }
        
        private async void UpdateLineNumbersAsync(TextBox lineNumbersBox, int lineCount)
        {
            try
            {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                var originalText = lineNumbersBox.Text;
                lineNumbersBox.Text = "åŠ è½½ä¸­...";
                
                // åœ¨åå°çº¿ç¨‹ç”Ÿæˆè¡Œå·
                var lineNumbers = await Task.Run(() => GenerateLineNumbers(lineCount));
                
                // å›åˆ°UIçº¿ç¨‹æ›´æ–°
                lineNumbersBox.Text = lineNumbers.Text;
                
                if (Math.Abs(lineNumbersBox.Width - lineNumbers.Width) > 5)
                {
                    lineNumbersBox.Width = lineNumbers.Width;
                }
                
                System.Diagnostics.Debug.WriteLine($"å·²å®Œæˆå¤§æ–‡ä»¶è¡Œå·æ›´æ–°: {lineCount}è¡Œ");
                UpdateStatus($"å·²åŠ è½½å¤§æ–‡ä»¶ï¼š{lineCount:N0}è¡Œ");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"å¼‚æ­¥æ›´æ–°è¡Œå·å¤±è´¥: {ex.Message}");
                // å¤±è´¥æ—¶æ˜¾ç¤ºåŸºæœ¬è¡Œå·
                lineNumbersBox.Text = "1"; 
                UpdateStatus("è¡Œå·åŠ è½½å¤±è´¥");
            }
        }
        
        private void UpdateLineNumbersForHugeFile(TextBox lineNumbersBox, int lineCount)
        {
            try
            {
                // å¯¹äºè¶…å¤§æ–‡ä»¶ï¼Œä½¿ç”¨è™šæ‹ŸåŒ–æ˜¾ç¤º
                lineNumbersBox.Text = "è¶…å¤§æ–‡ä»¶\nä½¿ç”¨\nè™šæ‹ŸåŒ–\nè¡Œå·";
                lineNumbersBox.Width = 60;
                UpdateStatus($"è¶…å¤§æ–‡ä»¶å·²åŠ è½½ï¼š{lineCount:N0}è¡Œï¼ˆä½¿ç”¨è™šæ‹ŸåŒ–è¡Œå·ï¼‰");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"è¶…å¤§æ–‡ä»¶è¡Œå·æ›´æ–°å¤±è´¥: {ex.Message}");
                lineNumbersBox.Text = "1";
                UpdateStatus("è¡Œå·åŠ è½½å¤±è´¥");
            }
        }
        
        /// <summary>
        /// åœ¨åå°çº¿ç¨‹ç”Ÿæˆè¡Œå·æ–‡æœ¬
        /// </summary>
        private (string Text, int Width) GenerateLineNumbers(int lineCount)
        {
            var sb = new StringBuilder(lineCount * 8); // é¢„åˆ†é…å®¹é‡
            var maxWidth = lineCount.ToString().Length;
            
            for (int i = 1; i <= lineCount; i++)
            {
                var lineNumber = i.ToString().PadLeft(maxWidth, ' ');
                
                if (i < lineCount)
                {
                    sb.AppendLine(lineNumber);
                }
                else
                {
                    sb.Append(lineNumber);
                }
                
                // æ¯1000è¡Œæ£€æŸ¥ä¸€æ¬¡å–æ¶ˆï¼ˆåœ¨å®é™…åº”ç”¨ä¸­å¯ä»¥è¿æ¥åˆ°å–æ¶ˆä»¤ç‰Œï¼‰
                if (i % 1000 == 0)
                {
                    // æ¨¡æ‹Ÿè®©å‡ºCPUæ—¶é—´ï¼Œé¿å…é˜»å¡
                    System.Threading.Thread.Yield();
                }
            }
            
            return (sb.ToString(), Math.Max(35, maxWidth * 8 + 16));
        }

        private void UpdateCursorPosition()
        {
            if (_currentTab?.TextEditor == null || CursorPositionText == null) return;

            var textEditor = _currentTab.TextEditor;
            var line = textEditor.GetLineIndexFromCharacterIndex(textEditor.CaretIndex) + 1;
            var column = textEditor.CaretIndex - textEditor.GetCharacterIndexFromLineIndex(line - 1) + 1;
            CursorPositionText.Text = $"è¡Œ {line}, åˆ— {column}";
        }
        
        private void UpdateSelectionInfo()
        {
            if (_currentTab?.TextEditor == null || SelectionInfoText == null)
            {
                if (SelectionInfoText != null)
                    SelectionInfoText.Visibility = Visibility.Collapsed;
                return;
            }

            var textEditor = _currentTab.TextEditor;
            if (textEditor.SelectionLength > 0)
            {
                var selectedText = textEditor.SelectedText;
                var charCount = selectedText.Length;
                var byteCount = Encoding.UTF8.GetByteCount(selectedText);
                SelectionInfoText.Text = $"é€‰ä¸­: {charCount}ä¸ªå­—ç¬¦ ({byteCount}å­—èŠ‚)";
                SelectionInfoText.Visibility = Visibility.Visible;
            }
            else
            {
                SelectionInfoText.Visibility = Visibility.Collapsed;
            }
        }

        private void UpdateTabList()
        {
            try
            {
                if (TabListMenuItem == null) return;
                
                TabListMenuItem.Items.Clear();
                
                for (int i = 0; i < _tabItems.Count; i++)
                {
                    var tab = _tabItems[i];
                    var menuItem = new MenuItem
                    {
                        Header = $"{i + 1}. {tab.DisplayName}",
                        IsChecked = tab == _currentTab,
                        Tag = tab
                    };
                    
                    menuItem.Click += (s, e) =>
                    {
                        try
                        {
                            var targetTab = (FileTabItem)((MenuItem)s).Tag;
                            SwitchToTab(targetTab);
                        }
                        catch (Exception ex)
                        {
                            System.Diagnostics.Debug.WriteLine($"æ ‡ç­¾é¡µåˆ—è¡¨ç‚¹å‡»é”™è¯¯: {ex.Message}");
                        }
                    };
                    
                    TabListMenuItem.Items.Add(menuItem);
                }
                
                if (_tabItems.Count == 0)
                {
                    var emptyItem = new MenuItem { Header = "æ— æ´»åŠ¨æ ‡ç­¾é¡µ", IsEnabled = false };
                    TabListMenuItem.Items.Add(emptyItem);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"æ›´æ–°æ ‡ç­¾é¡µåˆ—è¡¨é”™è¯¯: {ex.Message}");
            }
        }

        #endregion

        #region äº‹ä»¶å¤„ç†

        private void OnCurrentTabTextChanged()
        {
            if (_currentTab != null)
            {
                _currentTab.Content = WelcomeTextEditor.Text;
                
                // å¯¹äºå¤§æ–‡ä»¶ï¼Œä½¿ç”¨é˜²æŠ–åŠ¨æ›´æ–°è¡Œå·
                if (WelcomeTextEditor.LineCount > 10000)
                {
                    DebounceUpdateWelcomeLineNumbers();
                }
                else
                {
                    UpdateLineNumbers(WelcomeLineNumbers, WelcomeTextEditor);
                }
                
                UpdateTabHeader(_currentTab);
                UpdateTitle();
                UpdateStatus("å·²ä¿®æ”¹");
            }
        }
        
        private DispatcherTimer _welcomeLineNumberUpdateTimer;
        
        private void DebounceUpdateWelcomeLineNumbers()
        {
            // å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨
            _welcomeLineNumberUpdateTimer?.Stop();
            
            // åˆ›å»ºæ–°çš„å®šæ—¶å™¨ï¼Œ500msåæ›´æ–°
            _welcomeLineNumberUpdateTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(500)
            };
            
            _welcomeLineNumberUpdateTimer.Tick += (s, e) =>
            {
                _welcomeLineNumberUpdateTimer.Stop();
                UpdateLineNumbers(WelcomeLineNumbers, WelcomeTextEditor);
            };
            
            _welcomeLineNumberUpdateTimer.Start();
        }

        private void OnTabTextChanged(FileTabItem tab, TextBox textEditor)
        {
            if (tab != null)
            {
                tab.Content = textEditor.Text;
                
                // å¯¹äºå¤§æ–‡ä»¶ï¼Œä½¿ç”¨é˜²æŠ–åŠ¨æ›´æ–°è¡Œå·
                var charCount = textEditor.Text.Length;
                if (charCount > LARGE_FILE_THRESHOLD || textEditor.LineCount > 10000)
                {
                    DebounceUpdateLineNumbers(tab, textEditor);
                }
                else
                {
                    UpdateLineNumbers(tab.LineNumbersEditor, textEditor);
                }
                
                UpdateTabHeader(tab);
                if (tab == _currentTab)
                {
                    UpdateTitle();
                    UpdateStatus("å·²ä¿®æ”¹");
                }
            }
        }
        
        private DispatcherTimer _lineNumberUpdateTimer;
        private FileTabItem _pendingUpdateTab;
        private TextBox _pendingUpdateTextEditor;
        
        private void DebounceUpdateLineNumbers(FileTabItem tab, TextBox textEditor)
        {
            // å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨
            _lineNumberUpdateTimer?.Stop();
            
            _pendingUpdateTab = tab;
            _pendingUpdateTextEditor = textEditor;
            
            // åˆ›å»ºæ–°çš„å®šæ—¶å™¨ï¼Œæ ¹æ®æ–‡ä»¶å¤§å°è°ƒæ•´å»¶è¿Ÿæ—¶é—´
            var delayMs = textEditor.Text.Length > HUGE_FILE_THRESHOLD ? 1000 : 500;
            
            _lineNumberUpdateTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(delayMs)
            };
            
            _lineNumberUpdateTimer.Tick += (s, e) =>
            {
                _lineNumberUpdateTimer.Stop();
                if (_pendingUpdateTab != null && _pendingUpdateTextEditor != null)
                {
                    UpdateLineNumbers(_pendingUpdateTab.LineNumbersEditor, _pendingUpdateTextEditor);
                }
                _pendingUpdateTab = null;
                _pendingUpdateTextEditor = null;
            };
            
            _lineNumberUpdateTimer.Start();
        }

        private void TextEditor_PreviewKeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Tab)
            {
                var textBox = sender as TextBox;
                var selectionStart = textBox.SelectionStart;
                textBox.Text = textBox.Text.Insert(selectionStart, "    ");
                textBox.SelectionStart = selectionStart + 4;
                e.Handled = true;
        private void WelcomeTextEditor_ScrollChanged(object sender, ScrollChangedEventArgs e)
        {
            try
            {
                // åŒæ­¥è¡Œå·æ»šåŠ¨
                if (WelcomeLineNumbers != null)
                {
                    WelcomeLineNumbers.ScrollToVerticalOffset(e.VerticalOffset);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"æ¬¢è¿é¡µæ»šåŠ¨åŒæ­¥é”™è¯¯: {ex.Message}");
            }
        }

        #endregion

        #region è‡ªåŠ¨ç¼“å­˜åŠŸèƒ½
        
        private void InitializeAutoCache()
        {
            if (!Directory.Exists(_cacheDirectory))
            {
                Directory.CreateDirectory(_cacheDirectory);
            }
            
            _autoCacheTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromSeconds(60) // å¢åŠ åˆ°60ç§’ï¼Œå‡å°‘é¢‘ç¹å†™å…¥
            };
            _autoCacheTimer.Tick += AutoCache_Tick;
            _autoCacheTimer.Start();
            
            // å¯åŠ¨æ—¶å¼‚æ­¥æ¸…ç†è¿‡æœŸç¼“å­˜
            _ = Task.Run(CleanupOldCaches);
        }
        
        private async void AutoCache_Tick(object sender, EventArgs e)
        {
            try
            {
                var modifiedTabs = _tabItems.Where(t => t.IsModified && !string.IsNullOrEmpty(t.Content)).ToList();
                
                if (modifiedTabs.Any())
                {
                    // å¼‚æ­¥ä¿å­˜ç¼“å­˜ï¼Œé¿å…é˜»å¡UI
                    await Task.Run(() =>
                    {
                        foreach (var tab in modifiedTabs)
                        {
                            SaveAutoCache(tab);
                        }
                    });
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"è‡ªåŠ¨ç¼“å­˜é”™è¯¯: {ex.Message}");
            }
        }
        
        private void SaveAutoCache(FileTabItem tab)
        {
            // ä½¿ç”¨é”ç¡®ä¿çº¿ç¨‹å®‰å…¨
            lock (_cacheLock)
            {
                try
                {
                    var cacheFile = Path.Combine(_cacheDirectory, $"tab_cache_{tab.Id}.cache");
                    var metaFile = Path.Combine(_cacheDirectory, $"tab_cache_{tab.Id}.meta");
                    var gzipFile = Path.Combine(_cacheDirectory, $"tab_cache_{tab.Id}.cache.gz");
                    
                    // æ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰å˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„å†™å…¥
                    if (File.Exists(cacheFile))
                    {
                        var existingContent = File.ReadAllText(cacheFile, Encoding.UTF8);
                        if (existingContent == tab.Content)
                            return; // å†…å®¹æœªå˜åŒ–ï¼Œè·³è¿‡ä¿å­˜
                    }
                    
                    // æ£€æŸ¥gzipæ–‡ä»¶
                    if (File.Exists(gzipFile))
                    {
                        try
                        {
                            using (var fileStream = File.OpenRead(gzipFile))
                            using (var gzipStream = new GZipStream(fileStream, CompressionMode.Decompress))
                            using (var reader = new StreamReader(gzipStream, Encoding.UTF8))
                            {
                                var existingContent = reader.ReadToEnd();
                                if (existingContent == tab.Content)
                                    return; // å†…å®¹æœªå˜åŒ–ï¼Œè·³è¿‡ä¿å­˜
                            }
                        }
                        catch
                        {
                            // è§£å‹å¤±è´¥ï¼Œç»§ç»­ä¿å­˜
                        }
                    }
                    
                    // æ ¹æ®å†…å®¹å¤§å°å†³å®šæ˜¯å¦ä½¿ç”¨å‹ç¼©
                    bool useCompression = tab.Content.Length > CACHE_COMPRESS_THRESHOLD;
                    
                    if (useCompression)
                    {
                        SaveCompressedCache(gzipFile, tab.Content);
                        // åˆ é™¤æœªå‹ç¼©çš„ç¼“å­˜æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (File.Exists(cacheFile))
                        {
                            File.Delete(cacheFile);
                        }
                    }
                    else
                    {
                        File.WriteAllText(cacheFile, tab.Content, Encoding.UTF8);
                        // åˆ é™¤å‹ç¼©çš„ç¼“å­˜æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (File.Exists(gzipFile))
                        {
                            File.Delete(gzipFile);
                        }
                    }
                    
                    var metadata = new StringBuilder();
                    metadata.AppendLine($"FilePath={tab.FilePath ?? ""}");
                    metadata.AppendLine($"FileName={tab.FileName}");
                    metadata.AppendLine($"Encoding={tab.Encoding}");
                    metadata.AppendLine($"SaveTime={DateTime.Now:yyyy-MM-dd HH:mm:ss}");
                    metadata.AppendLine($"ContentLength={tab.Content.Length}");
                    metadata.AppendLine($"IsCompressed={useCompression}");
                    
                    File.WriteAllText(metaFile, metadata.ToString(), Encoding.UTF8);
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"è‡ªåŠ¨ç¼“å­˜å¤±è´¥: {ex.Message}");
                }
            }
        }
        
        private void SaveCompressedCache(string gzipFile, string content)
        {
            try
            {
                var bytes = Encoding.UTF8.GetBytes(content);
                using (var fileStream = File.Create(gzipFile))
                using (var gzipStream = new GZipStream(fileStream, CompressionMode.Compress, true))
                {
                    gzipStream.Write(bytes, 0, bytes.Length);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"å‹ç¼©ç¼“å­˜ä¿å­˜å¤±è´¥: {ex.Message}");
                // é™çº§åˆ°æ™®é€šä¿å­˜
                var cacheFile = gzipFile.Replace(".gz", "");
                File.WriteAllText(cacheFile, content, Encoding.UTF8);
            }
        }
        
        private string LoadCompressedCache(string gzipFile)
        {
            try
            {
                using (var fileStream = File.OpenRead(gzipFile))
                using (var gzipStream = new GZipStream(fileStream, CompressionMode.Decompress))
                using (var reader = new StreamReader(gzipStream, Encoding.UTF8))
                {
                    return reader.ReadToEnd();
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"å‹ç¼©ç¼“å­˜åŠ è½½å¤±è´¥: {ex.Message}");
                return null;
            }
        }
        
        private async Task CleanupOldCaches()
        {
            try
            {
                if (!Directory.Exists(_cacheDirectory))
                    return;
                
                var cacheFiles = Directory.GetFiles(_cacheDirectory, "*.cache")
                    .Concat(Directory.GetFiles(_cacheDirectory, "*.cache.gz"))
                    .ToList();
                
                var cutoffTime = DateTime.Now.AddDays(-CACHE_CLEANUP_INTERVAL); // åˆ é™¤7å¤©å‰çš„ç¼“å­˜
                
                foreach (var cacheFile in cacheFiles)
                {
                    var fileInfo = new FileInfo(cacheFile);
                    if (fileInfo.LastWriteTime < cutoffTime)
                    {
                        try
                        {
                            File.Delete(cacheFile);
                            
                            // åˆ é™¤å¯¹åº”çš„metaæ–‡ä»¶
                            var metaFile = cacheFile.Replace(".cache", ".meta").Replace(".gz", "");
                            if (File.Exists(metaFile))
                            {
                                File.Delete(metaFile);
                            }
                        }
                        catch (Exception ex)
                        {
                            System.Diagnostics.Debug.WriteLine($"åˆ é™¤ç¼“å­˜æ–‡ä»¶å¤±è´¥: {ex.Message}");
                        }
                    }
                }
                
                System.Diagnostics.Debug.WriteLine("ç¼“å­˜æ¸…ç†å®Œæˆ");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"ç¼“å­˜æ¸…ç†å¤±è´¥: {ex.Message}");
            }
        }

        protected override void OnClosing(System.ComponentModel.CancelEventArgs e)
        {
            try
            {
                _autoCacheTimer?.Stop();
                
                // ä¿å­˜çª—å£è®¾ç½®
                ConfigManager.SaveWindowSettings(this.ActualWidth, this.ActualHeight);
                
                // ä¿å­˜ä¼šè¯ä¿¡æ¯ï¼ˆåœ¨æ£€æŸ¥ä¿å­˜å‰ï¼‰
                SaveCurrentSession();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ–‡ä»¶
                var modifiedTabs = _tabItems.Where(t => t.IsModified).ToList();
                if (modifiedTabs.Count > 0)
                {
                    var result = MessageBox.Show(
                        $"æœ‰ {modifiedTabs.Count} ä¸ªæ–‡ä»¶æœªä¿å­˜ã€‚\næ˜¯å¦è¦ä¿å­˜è¿™äº›æ–‡ä»¶ï¼Ÿ",
                        "ä¿å­˜",
                        MessageBoxButton.YesNoCancel,
                        MessageBoxImage.Question);

                    switch (result)
                    {
                        case MessageBoxResult.Yes:
                            SaveAllFiles();
                            // ä¿å­˜åæ›´æ–°ä¼šè¯ä¿¡æ¯
                            SaveCurrentSession();
                            break;
                        case MessageBoxResult.Cancel:
                            e.Cancel = true;
                            return;
                    }
                }
                
                // å¼‚æ­¥ä¿å­˜æ‰€æœ‰ä¿®æ”¹çš„æ ‡ç­¾é¡µç¼“å­˜
                _ = Task.Run(() =>
                {
                    foreach (var tab in modifiedTabs)
                    {
                        SaveAutoCache(tab);
                    }
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"çª—å£å…³é—­å¤„ç†é”™è¯¯: {ex.Message}");
            }
            
            base.OnClosing(e);
        }

        private void SaveCurrentSession()
        {
            try
            {
                var sessionTabs = new List<ConfigManager.SessionTab>();
                var activeTabIndex = 0;

                for (int i = 0; i < _tabItems.Count; i++)
                {
                    var tab = _tabItems[i];
                    
                    // è·³è¿‡æ¬¢è¿é¡µ
                    if (tab.FileName == "æ¬¢è¿" && string.IsNullOrEmpty(tab.FilePath))
                        continue;

                    var sessionTab = new ConfigManager.SessionTab
                    {
                        FileName = tab.FileName,
                        FilePath = tab.FilePath ?? "",
                        Content = tab.Content ?? "",
                        Encoding = tab.Encoding ?? "UTF-8",
                        IsModified = tab.IsModified,
                        CursorPosition = tab.TextEditor?.CaretIndex ?? 0,
                        SelectionStart = tab.TextEditor?.SelectionStart ?? 0,
                        SelectionLength = tab.TextEditor?.SelectionLength ?? 0
                    };
                    
                    sessionTabs.Add(sessionTab);
                    
                    // è®°å½•å½“å‰æ´»è·ƒæ ‡ç­¾é¡µçš„ç´¢å¼•
                    if (tab == _currentTab)
                    {
                        activeTabIndex = sessionTabs.Count - 1;
                    }
                }

                ConfigManager.SaveSession(sessionTabs, activeTabIndex);
                System.Diagnostics.Debug.WriteLine($"å·²ä¿å­˜ä¼šè¯ï¼š{sessionTabs.Count}ä¸ªæ ‡ç­¾é¡µ");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"ä¿å­˜ä¼šè¯å¤±è´¥: {ex.Message}");
            }
        }

        #endregion

                }

                ConfigManager.SaveSession(sessionTabs, activeTabIndex);
                System.Diagnostics.Debug.WriteLine($"å·²ä¿å­˜ä¼šè¯ï¼š{sessionTabs.Count}ä¸ªæ ‡ç­¾é¡µ");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"ä¿å­˜ä¼šè¯å¤±è´¥: {ex.Message}");
            }
        }

        #endregion

        #region æ–‡ä»¶å¯¹æ¯”åŠŸèƒ½

        /// <summary>
        /// æ‰“å¼€æ–‡ä»¶å¯¹æ¯”çª—å£
        /// </summary>
        private void FileCompare()
        {
            try
            {
                var compareWindow = new FileCompareWindow
                {
                    Owner = this
                };
                compareWindow.Show();
                UpdateStatus("å·²æ‰“å¼€æ–‡ä»¶å¯¹æ¯”çª—å£");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"æ‰“å¼€å¯¹æ¯”çª—å£å¤±è´¥: {ex.Message}", "é”™è¯¯");
                System.Diagnostics.Debug.WriteLine($"æ–‡ä»¶å¯¹æ¯”é”™è¯¯: {ex}");
            }
        }

        /// <summary>
        /// å¯¹æ¯”å½“å‰æ‰“å¼€çš„æ–‡ä»¶
        /// </summary>
        private void CompareCurrentFiles()
        {
            try
            {
                if (_tabItems.Count < 2)
                {
                    MessageBox.Show("è‡³å°‘éœ€è¦æ‰“å¼€ä¸¤ä¸ªæ–‡ä»¶æ‰èƒ½è¿›è¡Œå¯¹æ¯”", "æç¤º", 
                        MessageBoxButton.OK, MessageBoxImage.Information);
                    return;
                }

                // ç›´æ¥å¯¹æ¯”æœ€åä¸¤ä¸ªæ‰“å¼€çš„æ–‡ä»¶
                var leftTab = _tabItems[_tabItems.Count - 2];
                var rightTab = _tabItems[_tabItems.Count - 1];

                var leftTitle = string.IsNullOrEmpty(leftTab.FilePath) ? leftTab.FileName : Path.GetFileName(leftTab.FilePath);
                var rightTitle = string.IsNullOrEmpty(rightTab.FilePath) ? rightTab.FileName : Path.GetFileName(rightTab.FilePath);

                var compareWindow = new FileCompareWindow(
                    leftTab.Content, 
                    rightTab.Content, 
                    leftTitle, 
                    rightTitle)
                {
                    Owner = this
                };
                compareWindow.Show();
                UpdateStatus($"å·²å¼€å§‹å¯¹æ¯”: {leftTitle} vs {rightTitle}");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"å¯¹æ¯”å½“å‰æ–‡ä»¶å¤±è´¥: {ex.Message}", "é”™è¯¯");
                System.Diagnostics.Debug.WriteLine($"å¯¹æ¯”å½“å‰æ–‡ä»¶é”™è¯¯: {ex}");
            }
        }

        #endregion

        #region èœå•å’Œå·¥å…·æ äº‹ä»¶

        private void NewFile_Click(object sender, RoutedEventArgs e) => NewFile();
        private void OpenFile_Click(object sender, RoutedEventArgs e) => OpenFile();
        private void SaveFile_Click(object sender, RoutedEventArgs e) => SaveFile();
        private void SaveAsFile_Click(object sender, RoutedEventArgs e) => SaveAsFile();
        private void SaveAllFiles_Click(object sender, RoutedEventArgs e) => SaveAllFiles();
        private void Exit_Click(object sender, RoutedEventArgs e) => Close();
        
        private void Find_Click(object sender, RoutedEventArgs e) => ShowFindDialog();
        private void FindReplace_Click(object sender, RoutedEventArgs e) => ShowFindReplaceDialog();
        private void BackupManager_Click(object sender, RoutedEventArgs e) => ShowBackupManager();
        
        private void ShowFindDialog()
        {
            if (_currentTab?.TextEditor != null)
            {
                var findDialog = new FindReplaceWindow(_currentTab.TextEditor)
                {
                    Owner = this
                };
                findDialog.ShowDialog();
            }
            else if (WelcomeTextEditor != null)
            {
                var findDialog = new FindReplaceWindow(WelcomeTextEditor)
                {
                    Owner = this
                };
                findDialog.ShowDialog();
            }
        }
        
        private void ShowFindReplaceDialog()
        {
            ShowFindDialog(); // å½“å‰å®ç°ä¸­æŸ¥æ‰¾å’Œæ›¿æ¢åœ¨åŒä¸€çª—å£
        }
        
        private void FindNext()
        {
            // F3å¿«æ·é”®æŸ¥æ‰¾ä¸‹ä¸€ä¸ª
            // è¿™é‡Œå¯ä»¥å®ç°è¿ç»­æŸ¥æ‰¾åŠŸèƒ½
            System.Diagnostics.Debug.WriteLine("æŸ¥æ‰¾ä¸‹ä¸€ä¸ª");
        }
        
        private async void ShowBackupManager()
        {
            try
            {
                var backupManager = new BackupManagerWindow(_currentTab?.FilePath)
                {
                    Owner = this
                };
                backupManager.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"æ‰“å¼€å¤‡ä»½ç®¡ç†å™¨å¤±è´¥: {ex.Message}", "é”™è¯¯");
            }
        }

        // æ ‡ç­¾é¡µç›¸å…³äº‹ä»¶
        private void CloseCurrentTab_Click(object sender, RoutedEventArgs e)
        {
            if (_currentTab != null) CloseTab(_currentTab);
        }

        private void CloseAllTabs_Click(object sender, RoutedEventArgs e)
        {
            var tabsToClose = _tabItems.ToList();
            foreach (var tab in tabsToClose)
            {
                CloseTab(tab);
            }
        }

        private void CloseOtherTabs_Click(object sender, RoutedEventArgs e)
        {
            if (_currentTab == null) return;
            
            var tabsToClose = _tabItems.Where(t => t != _currentTab).ToList();
            foreach (var tab in tabsToClose)
            {
                CloseTab(tab);
            }
        }

        private void NextTab_Click(object sender, RoutedEventArgs e)
        {
            if (_tabItems.Count <= 1) return;
            
            var currentIndex = _tabItems.IndexOf(_currentTab);
            var nextIndex = (currentIndex + 1) % _tabItems.Count;
            SwitchToTab(_tabItems[nextIndex]);
        }

        private void PreviousTab_Click(object sender, RoutedEventArgs e)
        {
            if (_tabItems.Count <= 1) return;
            
            var currentIndex = _tabItems.IndexOf(_currentTab);
            var previousIndex = currentIndex == 0 ? _tabItems.Count - 1 : currentIndex - 1;
            SwitchToTab(_tabItems[previousIndex]);
        }

        private void FileTabControl_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            var tabControl = sender as TabControl;
            if (tabControl.SelectedItem is TabItem selectedTab && selectedTab.DataContext is FileTabItem tab)
            {
                _currentTab = tab;
                UpdateTitle();
                UpdateCursorPosition();
                UpdateSelectionInfo();
                EncodingText.Text = tab.Encoding;
            }
        }

        private void FileTabControl_RightClick(object sender, MouseButtonEventArgs e)
        {
            // è·å–å³é”®ç‚¹å‡»çš„æ ‡ç­¾é¡µ
            var tabControl = sender as TabControl;
            var hitTest = e.OriginalSource as FrameworkElement;
            
            // å‘ä¸ŠæŸ¥æ‰¾åˆ°TabItem
            while (hitTest != null && !(hitTest is TabItem))
            {
                hitTest = hitTest.Parent as FrameworkElement ?? 
                         System.Windows.Media.VisualTreeHelper.GetParent(hitTest) as FrameworkElement;
            }
            
            if (hitTest is TabItem tabItem)
            {
                // å…ˆé€‰ä¸­è¢«å³é”®ç‚¹å‡»çš„æ ‡ç­¾é¡µ
                tabControl.SelectedItem = tabItem;
                
                // æ˜¾ç¤ºå³é”®èœå•
                TabContextMenu.IsOpen = true;
                e.Handled = true;
            }
        }

        private void FileTabControl_DoubleClick(object sender, MouseButtonEventArgs e)
        {
            // è·å–åŒå‡»ä½ç½®
            var tabControl = sender as TabControl;
            var hitTest = e.OriginalSource as FrameworkElement;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨æ ‡ç­¾é¡µä¸Š
            var originalHitTest = hitTest;
            while (hitTest != null && !(hitTest is TabItem))
            {
                hitTest = hitTest.Parent as FrameworkElement ?? 
                         System.Windows.Media.VisualTreeHelper.GetParent(hitTest) as FrameworkElement;
            }
            
            // å¦‚æœæ²¡æœ‰ç‚¹å‡»åœ¨æ ‡ç­¾é¡µä¸Šï¼Œè¯´æ˜ç‚¹å‡»çš„æ˜¯ç©ºç™½åŒºåŸŸ
            if (hitTest == null)
            {
                // ç¡®ä¿ç‚¹å‡»çš„æ˜¯ TabControl çš„ç©ºç™½åŒºåŸŸï¼Œè€Œä¸æ˜¯å…¶ä»–æ§ä»¶
                if (originalHitTest == tabControl || 
                    (originalHitTest != null && originalHitTest.GetType().Name.Contains("TabPanel")))
                {
                    // åŒå‡»ç©ºç™½åŒºåŸŸï¼Œåˆ›å»ºæ–°æ–‡ä»¶
                    CreateNewTab();
                    UpdateStatus("å·²åˆ›å»ºæ–°æ–‡ä»¶ï¼ˆåŒå‡»ç©ºç™½åŒºåŸŸï¼‰");
                    e.Handled = true;
                }
            }
        }

        // æ–‡ä»¶å¯¹æ¯”ç›¸å…³äº‹ä»¶
        private void FileCompare_Click(object sender, RoutedEventArgs e)
        {
            FileCompare();
        }

        private void CompareCurrentFiles_Click(object sender, RoutedEventArgs e)
        {
            CompareCurrentFiles();
        }

        private void DetectEncoding_Click(object sender, RoutedEventArgs e) => DetectEncoding();
        private void ConvertEncoding_Click(object sender, RoutedEventArgs e) => ConvertEncoding();

        private void ConvertToUtf8_Click(object sender, RoutedEventArgs e)
        {
            if (_currentTab != null)
            {
                _currentTab.Encoding = "UTF-8";
                _currentTab.Content = _currentTab.TextEditor.Text;
                EncodingText.Text = "UTF-8";
                UpdateStatus("ç¼–ç å·²è®¾ç½®ä¸º: UTF-8");
            }
        }

        private void ConvertToGbk_Click(object sender, RoutedEventArgs e)
        {
            if (_currentTab != null)
            {
                _currentTab.Encoding = "GBK";
                _currentTab.Content = _currentTab.TextEditor.Text;
                EncodingText.Text = "GBK";
                UpdateStatus("ç¼–ç å·²è®¾ç½®ä¸º: GBK");
            }
        }

        private void ConvertToUtf16_Click(object sender, RoutedEventArgs e)
        {
            if (_currentTab != null)
            {
                _currentTab.Encoding = "UTF-16";
                _currentTab.Content = _currentTab.TextEditor.Text;
                EncodingText.Text = "UTF-16";
                UpdateStatus("ç¼–ç å·²è®¾ç½®ä¸º: UTF-16");
            }
        }

        private void About_Click(object sender, RoutedEventArgs e)
        {
            var aboutText = "Smart Text Editor v1.2\n\n" +
                           "ä¸€æ¬¾åŸºäºC#å’ŒWPFå¼€å‘çš„æ™ºèƒ½æ–‡æœ¬ç¼–è¾‘å™¨\n" +
                           "æ”¯æŒå¤šæ ‡ç­¾é¡µç¼–è¾‘å’Œæ™ºèƒ½ç¼–ç ç®¡ç†\n\n" +
                           "æœ€æ–°åŠŸèƒ½ï¼š\n" +
                           "â€¢ å¤šä¸»é¢˜ç³»ç»Ÿ - 6ç§ç²¾ç¾ä¸»é¢˜ä»»æ‚¨é€‰æ‹©\n" +
                           "â€¢ å¤šæ ‡ç­¾é¡µç¼–è¾‘ç•Œé¢\n" +
                           "â€¢ æ™ºèƒ½æ–‡ä»¶ç®¡ç†\n" +
                           "â€¢ æ–‡ä»¶å¯¹æ¯”åŠŸèƒ½\n" +
                           "â€¢ ç°ä»£åŒ–ç”¨æˆ·ä½“éªŒ\n" +
                           "â€¢ é«˜æ€§èƒ½.NETè¿è¡Œæ—¶\n\n" +
                           "æ”¯æŒä¸»é¢˜ï¼š\n" +
                           "â€¢ æ·±è‰²ä¸»é¢˜ - GitHub Darké£æ ¼\n" +
                           "â€¢ æµ…è‰²ä¸»é¢˜ - æ¸…æ–°æ˜äº®é…è‰²\n" +
                           "â€¢ é«˜å¯¹æ¯”åº¦ - è§†è§‰éšœç¢å‹å¥½\n" +
                           "â€¢ æŠ¤çœ¼ä¸»é¢˜ - æš–è‰²è°ƒæŠ¤çœ¼é…è‰²\n" +
                           "â€¢ Monokai - ç»å…¸ç¨‹åºå‘˜ä¸»é¢˜\n" +
                           "â€¢ Solarized - ç§‘å­¦é…è‰²æ–¹æ¡ˆ\n\n" +
                           "ç‰ˆæƒæ‰€æœ‰ Â© 2024 Smart Text Editor Team";

            MessageBox.Show(aboutText, "å…³äº Smart Text Editor",
                MessageBoxButton.OK, MessageBoxImage.Information);
        }

        #endregion

        #region ä¸»é¢˜ç®¡ç†

        private void SetDarkTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Dark);
        }

        private void SetLightTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Light);
        }

        private void SetHighContrastTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.HighContrast);
        }

        private void SetEyeCareTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.EyeCare);
        }

        private void SetMonokaiTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Monokai);
        }

        private void SetSolarizedTheme_Click(object sender, RoutedEventArgs e)
        {
            PreviewAndSetTheme(ThemeType.Solarized);
        }

        /// <summary>
        /// é¢„è§ˆå¹¶è®¾ç½®ä¸»é¢˜
        /// </summary>
        private void PreviewAndSetTheme(ThemeType themeType)
        {
            try
            {
                // å¦‚æœæ­£åœ¨é¢„è§ˆå…¶ä»–ä¸»é¢˜ï¼Œå…ˆæ¢å¤å½“å‰ä¸»é¢˜
                if (_isPreviewingTheme && _previewTheme != ThemeManager.CurrentTheme)
                {
                    // æ¢å¤å½“å‰ä¸»é¢˜
                    ApplyThemeToUI(ThemeManager.CurrentTheme);
                }
                
                // åº”ç”¨é¢„è§ˆä¸»é¢˜
                ApplyThemeToUI(themeType);
                
                // è®¾ç½®é¢„è§ˆçŠ¶æ€
                _previewTheme = themeType;
                _isPreviewingTheme = true;
                
                // 3ç§’åè‡ªåŠ¨ç¡®è®¤æˆ–æ¢å¤
                var timer = new DispatcherTimer
                {
                    Interval = TimeSpan.FromSeconds(3)
                };
                timer.Tick += (s, e) =>
                {
                    timer.Stop();
                    if (_isPreviewingTheme)
                    {
                        ConfirmTheme(themeType);
                    }
                };
                timer.Start();
            }
            catch (Exception ex)
            {
                UpdateStatus($"ä¸»é¢˜é¢„è§ˆå¤±è´¥: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜é¢„è§ˆé”™è¯¯: {ex}");
            }
        }
        
        /// <summary>
        /// åº”ç”¨ä¸»é¢˜åˆ°UIï¼ˆé¢„è§ˆæˆ–æ­£å¼åº”ç”¨ï¼‰
        /// </summary>
        private void ApplyThemeToUI(ThemeType themeType)
        {
            var themeColors = ThemeManager.GetThemeColors(themeType);
            
            // åº”ç”¨ä¸»é¢˜åˆ°ä¸»çª—å£
            ThemeApplier.ApplyThemeToMainWindow(this, themeColors);
            
            // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
            foreach (var tabItem in _tabItems)
            {
                ThemeApplier.ApplyToTabItem(tabItem, themeColors);
            }
            
            // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€ï¼ˆé¢„è§ˆæ—¶ä¸æ›´æ–°ï¼‰
            if (!_isPreviewingTheme || themeType == ThemeManager.CurrentTheme)
            {
                UpdateThemeMenuSelection(themeType);
            }
        }
        
        /// <summary>
        /// ç¡®è®¤ä¸»é¢˜é€‰æ‹©
        /// </summary>
        private void ConfirmTheme(ThemeType themeType)
        {
            try
            {
                // è®¾ç½®ä¸»é¢˜
                ThemeManager.SetTheme(themeType);
                var themeColors = ThemeManager.GetCurrentThemeColors();
                
                // åº”ç”¨ä¸»é¢˜åˆ°ä¸»çª—å£
                ThemeApplier.ApplyThemeToMainWindow(this, themeColors);
                
                // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
                foreach (var tabItem in _tabItems)
                {
                    ThemeApplier.ApplyToTabItem(tabItem, themeColors);
                }
                
                // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
                UpdateThemeMenuSelection(themeType);
                
                // ä¿å­˜ä¸»é¢˜è®¾ç½®
                ConfigManager.SaveTheme(themeType);
                
                // é‡ç½®é¢„è§ˆçŠ¶æ€
                _isPreviewingTheme = false;
                
                // æ›´æ–°çŠ¶æ€
                UpdateStatus($"ä¸»é¢˜å·²åˆ‡æ¢ä¸º: {themeColors.Name}ï¼Œå·²ä¿å­˜è®¾ç½®");
            }
            catch (Exception ex)
            {
                UpdateStatus($"ä¸»é¢˜åˆ‡æ¢å¤±è´¥: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜åˆ‡æ¢é”™è¯¯: {ex}");
            }
        }

        private void SetTheme(ThemeType themeType)
        {
            try
            {
                // è®¾ç½®ä¸»é¢˜
                ThemeManager.SetTheme(themeType);
                var themeColors = ThemeManager.GetCurrentThemeColors();

                // åº”ç”¨ä¸»é¢˜åˆ°ä¸»çª—å£
                ThemeApplier.ApplyThemeToMainWindow(this, themeColors);

                // åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
                foreach (var tabItem in _tabItems)
                {
                    ThemeApplier.ApplyToTabItem(tabItem, themeColors);
                }

                // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
                UpdateThemeMenuSelection(themeType);

                // ä¿å­˜ä¸»é¢˜è®¾ç½®
                ConfigManager.SaveTheme(themeType);

                // æ›´æ–°çŠ¶æ€
                UpdateStatus($"ä¸»é¢˜å·²åˆ‡æ¢ä¸º: {themeColors.Name}ï¼Œå·²ä¿å­˜è®¾ç½®");
            }
            catch (Exception ex)
            {
                UpdateStatus($"ä¸»é¢˜åˆ‡æ¢å¤±è´¥: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ä¸»é¢˜åˆ‡æ¢é”™è¯¯: {ex}");
            }
        }

        private void UpdateThemeMenuSelection(ThemeType selectedTheme)
        {
            // å–æ¶ˆæ‰€æœ‰ä¸»é¢˜èœå•é¡¹çš„é€‰ä¸­çŠ¶æ€
            DarkThemeMenuItem.IsChecked = false;
            LightThemeMenuItem.IsChecked = false;
            HighContrastThemeMenuItem.IsChecked = false;
            EyeCareThemeMenuItem.IsChecked = false;
            MonokaiThemeMenuItem.IsChecked = false;
            SolarizedThemeMenuItem.IsChecked = false;

            // è®¾ç½®å½“å‰ä¸»é¢˜èœå•é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
            switch (selectedTheme)
            {
                case ThemeType.Dark:
                    DarkThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.Light:
                    LightThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.HighContrast:
                    HighContrastThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.EyeCare:
                    EyeCareThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.Monokai:
                    MonokaiThemeMenuItem.IsChecked = true;
                    break;
                case ThemeType.Solarized:
                    SolarizedThemeMenuItem.IsChecked = true;
                    break;
            }
            
            // åŒæ—¶æ›´æ–°å·¥å…·æ ä¸Šçš„ComboBoxé€‰æ‹©
            UpdateThemeComboBox(selectedTheme);
        }
        
        private void UpdateThemeComboBox(ThemeType selectedTheme)
        {
            if (ThemeSelector == null) return;
            
            // ä¸´æ—¶ç§»é™¤äº‹ä»¶å¤„ç†å™¨ï¼Œé¿å…å¾ªç¯è§¦å‘
            ThemeSelector.SelectionChanged -= ThemeSelector_SelectionChanged;
            
            var themeTag = selectedTheme.ToString();
            foreach (ComboBoxItem item in ThemeSelector.Items)
            {
                if (item.Tag?.ToString() == themeTag)
                {
                    ThemeSelector.SelectedItem = item;
                    break;
                }
            }
            
            // é‡æ–°æ·»åŠ äº‹ä»¶å¤„ç†å™¨
            ThemeSelector.SelectionChanged += ThemeSelector_SelectionChanged;
        }
        
        private void ThemeSelector_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // é˜²æ­¢åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­è§¦å‘
            if (!_isFullyInitialized || sender is not ComboBox comboBox || comboBox.SelectedItem is not ComboBoxItem selectedItem)
                return;
                
            var themeTag = selectedItem.Tag?.ToString();
            if (Enum.TryParse<ThemeType>(themeTag, out var themeType))
            {
                SetTheme(themeType);
            }
        }

        #endregion

        #region è¾…åŠ©æ–¹æ³•

        private static T FindParent<T>(DependencyObject child) where T : DependencyObject
        {
            var parent = VisualTreeHelper.GetParent(child);
            if (parent == null) return null;
            return parent is T ? (T)parent : FindParent<T>(parent);
        }

        #endregion
    }
}